<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>View & Run guess.py (Pyodide)</title>

  <!-- Prism for syntax highlighting -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism.min.css" rel="stylesheet" />
  <style>
    :root{
      --bg:#0f1724; --card:#0b1220; --muted:#9aa5b1; --accent:#60a5fa;
      --panel:#0b1220; --mono: "Fira Code", ui-monospace, SFMono-Regular, Menlo, Monaco, "Roboto Mono", "Courier New", monospace;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,#071027 0%, #081326 100%);font-family:Inter,system-ui,Segoe UI,Roboto,Arial;}
    .wrap{max-width:980px;margin:28px auto;padding:20px;color:#e6eef6}
    header{display:flex;align-items:center;gap:14px;margin-bottom:18px}
    header h1{font-size:20px;margin:0}
    .controls{display:flex;gap:10px;flex-wrap:wrap;margin-bottom:12px}
    .btn{
      background:var(--accent);color:#022;border:none;padding:8px 12px;border-radius:8px;cursor:pointer;font-weight:600;
      box-shadow:0 4px 14px rgba(96,165,250,0.12);
    }
    .btn-ghost{background:transparent;color:var(--accent);border:1px solid rgba(96,165,250,0.12)}
    .card{background:linear-gradient(180deg, rgba(255,255,255,0.03), rgba(255,255,255,0.015)); padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.03);box-shadow:0 6px 18px rgba(2,6,23,0.6)}
    label{color:var(--muted);font-size:13px}
    #codeArea{width:100%;height:320px;font-family:var(--mono);font-size:13px;padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.03);background:#02101a;color:#eaf4ff;resize:vertical;white-space:pre;overflow:auto}
    #output{width:100%;min-height:140px;padding:12px;border-radius:8px;background:#020912;color:#dff2ff;border:1px solid rgba(255,255,255,0.03);font-family:var(--mono);white-space:pre-wrap}
    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px;margin-top:12px}
    @media (max-width:820px){ .row{grid-template-columns:1fr} }
    small{color:var(--muted)}
    .topline{display:flex;gap:10px;align-items:center}
    .status{font-size:13px;color:var(--muted);margin-left:auto}
  </style>
</head>
<body>
  <div class="wrap">
    <header>
      <div>
        <h1>View & Run <code>guess.py</code> — in-browser</h1>
        <small>Load a local <code>guess.py</code> file or paste code, then press Run.</small>
      </div>
      <div class="status" id="status">Pyodide: not loaded</div>
    </header>

    <div class="card">
      <div class="controls">
        <label class="btn btn-ghost">
          Choose file
          <input id="fileInput" type="file" accept=".py" style="display:none" />
        </label>

        <button class="btn" id="runBtn">Run</button>
        <button class="btn btn-ghost" id="clearOut">Clear Output</button>
        <button class="btn btn-ghost" id="exampleBtn">Load Example</button>
        <a class="btn btn-ghost" id="downloadBtn" href="#" download="guess.py">Download current</a>
      </div>

      <label for="codeArea">Python source</label>
      <textarea id="codeArea" spellcheck="false" placeholder="# Paste your guess.py here or choose a file..."></textarea>

      <div class="row" style="margin-top:14px">
        <div>
          <label>Highlighted source</label>
          <div id="highlightWrap" class="card" style="height:320px;overflow:auto">
            <pre style="margin:0"><code id="highlight" class="language-python"></code></pre>
          </div>
        </div>

        <div>
          <label>Program output</label>
          <div id="output" aria-live="polite"></div>
        </div>
      </div>

      <div style="margin-top:12px">
        <small>
          This page uses <code>Pyodide</code> (Python in WebAssembly) to run code in your browser — no server. If your program expects interactive terminal input (like input()), you'll need to modify it to accept input via the web UI or preset values.
        </small>
      </div>
    </div>
  </div>

  <!-- Prism & Pyodide -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-python.min.js"></script>

  <!-- Pyodide: official CDN -->
  <script>
    // Load pyodide asynchronously
    const statusEl = document.getElementById('status');
    let pyodide = null;

    async function loadPyodideAndPackages() {
      statusEl.textContent = 'Loading Pyodide (this can take a few seconds)...';
      try {
        self.languagePluginUrl = "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/"; // base for pyodide assets
        pyodide = await loadPyodide({ indexURL: "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/" });
        statusEl.textContent = 'Pyodide: ready';
      } catch (err) {
        statusEl.textContent = 'Pyodide: failed to load';
        console.error(err);
      }
    }

    // Kick off loading
    (async () => {
      // insert pyodide loader script
      const s = document.createElement('script');
      s.src = "https://cdn.jsdelivr.net/pyodide/v0.23.4/full/pyodide.js";
      s.onload = loadPyodideAndPackages;
      s.onerror = () => statusEl.textContent = 'Pyodide script failed to load';
      document.head.appendChild(s);
    })();
  </script>

  <script>
    const fileInput = document.getElementById('fileInput');
    const codeArea = document.getElementById('codeArea');
    const highlight = document.getElementById('highlight');
    const runBtn = document.getElementById('runBtn');
    const output = document.getElementById('output');
    const clearOut = document.getElementById('clearOut');
    const exampleBtn = document.getElementById('exampleBtn');
    const downloadBtn = document.getElementById('downloadBtn');

    function updateHighlight() {
      // escape HTML and put into code block
      const escaped = codeArea.value.replace(/&/g, '&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;');
      highlight.innerHTML = escaped || '# No code loaded';
      Prism.highlightElement(highlight);
      // update downloadable blob
      const blob = new Blob([codeArea.value], {type: 'text/x-python'});
      downloadBtn.href = URL.createObjectURL(blob);
    }

    codeArea.addEventListener('input', updateHighlight);

    fileInput.addEventListener('change', (e) => {
      const f = e.target.files[0];
      if (!f) return;
      const reader = new FileReader();
      reader.onload = () => {
        codeArea.value = reader.result;
        updateHighlight();
      };
      reader.readAsText(f);
    });

    clearOut.addEventListener('click', () => { output.textContent = ''; });

    exampleBtn.addEventListener('click', () => {
      const example = `import random

# Simple number guessing (non-interactive demo for browser)
secret = random.randint(1, 100)
guesses = [50, 25, 75, 62, 56, 59, 60]  # example guess sequence
print("Secret (hidden):", secret)
for i, g in enumerate(guesses, start=1):
    print(f"Try {i}: guess={g}")
    if g == secret:
        print("-> Correct!")
        break
    elif g < secret:
        print("-> too low")
    else:
        print("-> too high")
else:
    print("No correct guess in example sequence.")`;
      codeArea.value = example;
      updateHighlight();
    });

    // run code via pyodide
    runBtn.addEventListener('click', async () => {
      if (!pyodide) {
        alert('Pyodide is still loading — wait a few seconds and try again.');
        return;
      }
      output.textContent = 'Running...';
      runBtn.disabled = true;
      try {
        const userCode = codeArea.value || '# (no code)';
        // Wrap code to capture stdout and exceptions, then return stdout contents
        const wrapped = `
import sys, io, traceback
_stdout = io.StringIO()
_old_stdout = sys.stdout
sys.stdout = _stdout
try:
${userCode.split('\\n').map(line => '    ' + line).join('\\n')}
except Exception:
    traceback.print_exc()
finally:
    sys.stdout = _old_stdout
_stdout.getvalue()
`;
        const result = await pyodide.runPythonAsync(wrapped);
        output.textContent = result ?? '';
      } catch (err) {
        output.textContent = 'Error running code: ' + String(err);
        console.error(err);
      } finally {
        runBtn.disabled = false;
      }
    });

    // initialize with a small hint
    codeArea.value = `# Paste your guess.py here, or click "Choose file" to load it.\n# When ready, click Run.\n`;
    updateHighlight();
  </script>
</body>
</html>
